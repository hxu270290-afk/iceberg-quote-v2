<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Iceberg 3D – Custom Print Quote (v2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- three.js & helpers -->
<!-- three.js core -->
<script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
<!-- controls & loader -->
<script src="https://unpkg.com/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
<script src="https://unpkg.com/three@0.152.2/examples/js/loaders/STLLoader.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", 
sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 4px;
    }
    .subtitle {
      margin: 0 0 20px;
      color: #6b7280;
      font-size: 14px;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: 1.2fr 1.2fr 1fr;
      gap: 20px;
    }
    @media (max-width: 1024px) {
      .grid-3 {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
    }
    .card h2 {
      margin: 0 0 12px;
      font-size: 16px;
    }
    .section-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    label {
      font-size: 13px;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }
    input[type="file"],
    input[type="number"],
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      background: #ffffff;
    }
    .field { margin-bottom: 12px; }
    .hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }
    .row {
      display: flex;
      gap: 10px;
    }
    .row > .field {
      flex: 1;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0 4px;
      font-size: 13px;
    }
    button {
      background: #2563eb;
      color: #ffffff;
      border: none;
      border-radius: 999px;
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }
    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .result-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .result-row strong { font-weight: 600; }
    .total-row {
      border-top: 1px solid #e5e7eb;
      padding-top: 8px;
      margin-top: 8px;
      font-size: 15px;
      font-weight: 700;
    }
    .error {
      color: #b91c1c;
      font-size: 12px;
      margin-top: 8px;
    }
    .muted {
      color: #6b7280;
      font-size: 11px;
      margin-top: 6px;
    }
    /* preview area */
    #preview-wrapper {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: radial-gradient(circle at top, #e5f0ff 0, #f9fafb 40%, 
#ffffff 100%);
      height: 260px;
      position: relative;
      overflow: hidden;
    }
    #preview-canvas {
      width: 100%;
      height: 100%;
    }
    #preview-loading {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: #6b7280;
      pointer-events: none;
    }
    .preview-footer {
      margin-top: 8px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .preview-meta {
      font-size: 11px;
      color: #4b5563;
    }
    .preview-meta span {
      margin-right: 8px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      font-size: 11px;
    }
    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    input[type="range"] {
      flex: 1;
    }
    .colour-swatches {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .swatch {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      cursor: pointer;
      position: relative;
    }
    .swatch.selected::after {
      content: "";
      position: absolute;
      inset: 3px;
      border-radius: 999px;
      border: 2px solid #ffffff;
      box-shadow: 0 0 0 1px #1d4ed8;
    }
  </style>
</head>
<body>
<div class="page">
  <h1>Iceberg 3D – Instant Custom Print Quote (v2)</h1>
  <p class="subtitle">
    Upload your STL file, configure basic settings, preview your model in 
3D and get an instant estimate.
  </p>

  <div class="grid-3">
    <!-- 1. Upload & Preview -->
    <div class="card">
      <div class="section-title">1 · Model & Preview</div>
      <div class="field">
        <label for="file">3D Model File (STL / OBJ)</label>
        <input id="file" name="file" type="file" accept=".stl,.obj" />
        <div class="hint">Upload your model file. For STEP or special 
formats, you can email us separately.</div>
      </div>

      <div id="preview-wrapper">
        <div id="preview-canvas"></div>
        <div id="preview-loading" style="display:none;">Processing 
model…</div>
      </div>

      <div class="preview-footer">
        <div class="preview-meta" id="preview-meta">
          <span>No model loaded</span>
        </div>
        <div class="btn-group">
          <button type="button" class="btn-secondary" 
id="btn-view-iso">Isometric</button>
          <button type="button" class="btn-secondary" 
id="btn-view-top">Top</button>
          <button type="button" class="btn-secondary" 
id="btn-view-front">Front</button>
          <button type="button" class="btn-secondary" 
id="btn-view-reset">Reset</button>
        </div>
      </div>
    </div>

    <!-- 2. Configure basic options -->
    <div class="card">
      <div class="section-title">2 · Configure Your Print (Basic)</div>

      <div class="field">
        <label>Printing Technology</label>
        <div class="pill">FDM – Fused Deposition Modelling</div>
        <div class="hint">
          For SLA resin or metal printing, please email
          <a 
href="mailto:simon@iceberg3d.co.uk">simon@iceberg3d.co.uk</a>.
        </div>
      </div>

      <div class="field">
        <label for="material">Material</label>
        <select id="material">
          <option value="pla_basic">PLA Basic</option>
          <option value="petg_basic">PETG Basic</option>
          <option value="pla_silk">PLA Silk</option>
          <!-- TODO: 将来在这里扩展你全部的材料列表 -->
        </select>
        <div class="hint">We’ll use Bambu X1C compatible filaments. 
Different materials will affect strength and price.</div>
      </div>

      <div class="field">
        <label>Colour</label>
        <div class="colour-swatches" id="colour-swatches">
          <!-- 这里只是示例，将来按 Bambu 官方色卡补全 -->
          <div class="swatch" data-colour="black" 
style="background:#111827;"></div>
          <div class="swatch" data-colour="white" 
style="background:#f9fafb;"></div>
          <div class="swatch" data-colour="grey" 
style="background:#9ca3af;"></div>
          <div class="swatch" data-colour="red" 
style="background:#ef4444;"></div>
          <div class="swatch" data-colour="blue" 
style="background:#2563eb;"></div>
          <div class="swatch" data-colour="gradient" 
style="background:linear-gradient(45deg,#ec4899,#6366f1);"></div>
        </div>
        <div class="hint">If you’re not sure, just leave it – we’ll 
default to black or white depending on stock.</div>
      </div>

      <div class="field">
        <label for="layer_height">Layer Height (Detail)</label>
        <select id="layer_height">
          <option value="0.20">Standard – 0.20 mm (recommended)</option>
          <option value="0.16">Medium – 0.16 mm</option>
          <option value="0.12">High – 0.12 mm</option>
          <option value="0.08">Ultra – 0.08 mm</option>
          <option value="0.24">Draft – 0.24 mm</option>
          <option value="0.28">Fast – 0.28 mm</option>
        </select>
        <div class="hint">The smaller the number, the higher the detail – 
but also longer print time and higher cost.</div>
      </div>

      <div class="field">
        <label for="infill">Infill Density</label>
        <div class="slider-row">
          <input id="infill" type="range" min="0" max="100" step="5" 
value="20" />
          <span id="infill-value" 
style="width:40px;text-align:right;font-size:13px;">20%</span>
        </div>
        <div class="hint">
          10–25%: most display parts · 40%+: stronger functional parts · 
80%+: near solid, heavy and more expensive.
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="quantity">Quantity</label>
          <input id="quantity" type="number" min="1" max="20" value="1" />
        </div>
        <div class="field">
          <div class="checkbox-row">
            <input id="rush" type="checkbox" />
            <label for="rush" style="margin:0;font-weight:500;">Rush order 
(priority printing)</label>
          </div>
          <div class="hint">We’ll prioritise your job in our queue. Extra 
fee may apply.</div>
        </div>
      </div>

      <button id="btn-quote">
        Get Quote
        <span id="btn-spinner" style="display:none;">⏳</span>
      </button>
      <div id="form-error" class="error"></div>
      <div class="muted">
        This is an automated estimate. Final price may be adjusted after 
manual review, especially for very thin walls or special requirements.
      </div>
    </div>

    <!-- 3. Quote & Review -->
    <div class="card">
      <div class="section-title">3 · Quote & Review</div>
      <div id="quote-empty">
        <p style="font-size:13px;color:#6b7280;">
          Configure your print on the left and click <strong>Get 
Quote</strong>.  
          We’ll estimate price based on model size, material and settings.
        </p>
      </div>
      <div id="quote-result" style="display:none;">
        <div class="result-row">
          <span>Price per part</span>
          <strong id="qr-price-per-part">–</strong>
        </div>
        <div class="result-row">
          <span>Quantity</span>
          <span id="qr-quantity">–</span>
        </div>
        <div class="result-row">
          <span>Material</span>
          <span id="qr-material">–</span>
        </div>
        <div class="result-row">
          <span>Layer height</span>
          <span id="qr-layer">–</span>
        </div>
        <div class="result-row">
          <span>Infill</span>
          <span id="qr-infill">–</span>
        </div>
        <div class="result-row">
          <span>Rush order</span>
          <span id="qr-rush">–</span>
        </div>
        <div class="result-row">
          <span>Volume</span>
          <span id="qr-volume">–</span>
        </div>
        <div class="result-row">
          <span>Estimated weight</span>
          <span id="qr-weight">–</span>
        </div>
        <div class="total-row">
          <span>Total</span>
          <span id="qr-total">–</span>
        </div>
        <div class="muted">
          Happy with this estimate? You can proceed on the main Iceberg 3D 
site or send us this quote reference via email.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== 3D PREVIEW SETUP =====
  let scene, camera, renderer, controls;
  let currentMesh = null;
  let boxHelper = null;
  const previewContainer = document.getElementById("preview-canvas");
  const loadingEl = document.getElementById("preview-loading");
  const previewMeta = document.getElementById("preview-meta");

  function initPreview() {
    const width = previewContainer.clientWidth || 300;
    const height = previewContainer.clientHeight || 260;

    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(40, width / height, 0.1, 1000);
    camera.position.set(120, 90, 120);

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(width, height);
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    previewContainer.innerHTML = "";
    previewContainer.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.09;

    // lights
    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.9);
    hemiLight.position.set(0, 200, 0);
    scene.add(hemiLight);

    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(80, 120, 80);
    scene.add(dirLight);

    // grid
    const grid = new THREE.GridHelper(200, 20, 0xe5e7eb, 0xe5e7eb);
    grid.position.y = 0;
    scene.add(grid);

    animate();
    window.addEventListener("resize", onWindowResize);
  }

  function onWindowResize() {
    if (!camera || !renderer) return;
    const width = previewContainer.clientWidth || 300;
    const height = previewContainer.clientHeight || 260;
    camera.aspect = width / height;
    camera.updateProjectionMatrix();
    renderer.setSize(width, height);
  }

  function animate() {
    requestAnimationFrame(animate);
    if (controls) controls.update();
    if (renderer && scene && camera) renderer.render(scene, camera);
  }

  function loadModelFromFile(file) {
    if (!file) return;
    loadingEl.style.display = "flex";
    const reader = new FileReader();
    reader.onload = function (e) {
      const arrayBuffer = e.target.result;
      const loader = new THREE.STLLoader();
      const geometry = loader.parse(arrayBuffer);
      geometry.computeVertexNormals();
      const material = new THREE.MeshStandardMaterial({ color: 0x9ca3af, 
metalness: 0.1, roughness: 0.6 });
      const mesh = new THREE.Mesh(geometry, material);

      // remove old
      if (currentMesh) {
        scene.remove(currentMesh);
        currentMesh.geometry.dispose();
      }
      if (boxHelper) {
        scene.remove(boxHelper);
      }

      // center & place on grid
      geometry.computeBoundingBox();
      const box = geometry.boundingBox;
      const size = new THREE.Vector3();
      box.getSize(size);
      const center = new THREE.Vector3();
      box.getCenter(center);

      mesh.position.x = -center.x;
      mesh.position.z = -center.z;
      mesh.position.y = -box.min.y; // bottom on grid

      scene.add(mesh);
      currentMesh = mesh;

      // bounding box helper
      boxHelper = new THREE.Box3Helper(new 
THREE.Box3().setFromObject(mesh), 0x60a5fa);
      scene.add(boxHelper);

      // update camera a bit
      const maxDim = Math.max(size.x, size.y, size.z);
      const dist = maxDim * 1.8 + 40;
      camera.position.set(dist, dist * 0.8, dist);
      controls.target.set(0, size.y / 2, 0);
      controls.update();

      // update text
      previewMeta.innerHTML = `
        <span>Size: ${size.x.toFixed(1)} × ${size.y.toFixed(1)} × 
${size.z.toFixed(1)} mm</span>
      `;
      loadingEl.style.display = "none";
    };
    reader.onerror = function () {
      loadingEl.style.display = "none";
      previewMeta.textContent = "Failed to load preview. You can still 
request a quote.";
    };
    reader.readAsArrayBuffer(file);
  }

  // view buttons
  document.getElementById("btn-view-iso").addEventListener("click", () => 
{
    camera.position.set(120, 90, 120);
    controls.target.set(0, 40, 0);
    controls.update();
  });
  document.getElementById("btn-view-top").addEventListener("click", () => 
{
    camera.position.set(0, 200, 0.001);
    controls.target.set(0, 0, 0);
    controls.update();
  });
  document.getElementById("btn-view-front").addEventListener("click", () 
=> {
    camera.position.set(0, 80, 160);
    controls.target.set(0, 40, 0);
    controls.update();
  });
  document.getElementById("btn-view-reset").addEventListener("click", () 
=> {
    camera.position.set(120, 90, 120);
    controls.target.set(0, 40, 0);
    controls.update();
  });

  // file change -> preview
  document.getElementById("file").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    loadModelFromFile(file);
  });

  // ===== COLOUR SWATCHES =====
  let selectedColour = null;
  const swatchContainer = document.getElementById("colour-swatches");
  swatchContainer.addEventListener("click", (e) => {
    const target = e.target.closest(".swatch");
    if (!target) return;
    [...swatchContainer.querySelectorAll(".swatch")].forEach((el) => 
el.classList.remove("selected"));
    target.classList.add("selected");
    selectedColour = target.dataset.colour;
  });

  // ===== INFILL SLIDER =====
  const infillSlider = document.getElementById("infill");
  const infillValue = document.getElementById("infill-value");
  infillSlider.addEventListener("input", () => {
    infillValue.textContent = infillSlider.value + "%";
  });

  // ===== QUOTE BUTTON / API CALL =====
  const btnQuote = document.getElementById("btn-quote");
  const btnSpinner = document.getElementById("btn-spinner");
  const formError = document.getElementById("form-error");
  const quoteEmpty = document.getElementById("quote-empty");
  const quoteResult = document.getElementById("quote-result");

  btnQuote.addEventListener("click", async () => {
    formError.textContent = "";

    const fileInput = document.getElementById("file");
    if (!fileInput.files[0]) {
      formError.textContent = "Please upload a 3D model file first.";
      return;
    }

    const quantity = parseInt(document.getElementById("quantity").value || 
"1", 10);
    if (!quantity || quantity < 1) {
      formError.textContent = "Quantity must be at least 1.";
      return;
    }

    btnQuote.disabled = true;
    btnSpinner.style.display = "inline";
    quoteEmpty.style.display = "block";
    quoteResult.style.display = "none";

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);
    formData.append("material", 
document.getElementById("material").value);
    formData.append("layer_height", 
document.getElementById("layer_height").value);
    formData.append("quantity", String(quantity));
    formData.append("rush", document.getElementById("rush").checked ? 
"true" : "false");
    formData.append("infill", infillSlider.value); // 
暂时后端不使用，但先传过去
    if (selectedColour) {
      formData.append("colour", selectedColour);
    }

    try {
      const response = await fetch("http://127.0.0.1:8000/api/quote", {
        method: "POST",
        body: formData,
      });
      const data = await response.json();
      if (!data.success) {
        throw new Error(data.error || "Unknown error.");
      }
      const d = data.data;

      document.getElementById("qr-price-per-part").textContent =
        d.currency + " " + d.price_per_part;
      document.getElementById("qr-quantity").textContent = d.quantity;
      document.getElementById("qr-material").textContent = d.material;
      document.getElementById("qr-layer").textContent = d.layer_height + " 
mm";
      document.getElementById("qr-infill").textContent = 
infillSlider.value + "%";
      document.getElementById("qr-rush").textContent = d.rush_order ? 
"Yes" : "No";
      document.getElementById("qr-volume").textContent = d.volume_cm3 + " 
cm³";
      document.getElementById("qr-weight").textContent = 
d.estimated_weight_g + " g";
      document.getElementById("qr-total").textContent =
        d.currency + " " + d.total_price;

      quoteEmpty.style.display = "none";
      quoteResult.style.display = "block";
    } catch (err) {
      formError.textContent = err.message || "Failed to get quote.";
    } finally {
      btnQuote.disabled = false;
      btnSpinner.style.display = "none";
    }
  });

  initPreview();
alert("Iceberg v2 script loaded");
  initPreview();
</script>
</body>
</html>

