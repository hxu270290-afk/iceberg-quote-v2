<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Iceberg 3D – Custom Print Quote v2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- three.js -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/js/loaders/STLLoader.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/js/loaders/OBJLoader.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/js/libs/fflate.min.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/js/loaders/3MFLoader.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #f9fafb 45%, #f3f4f6 100%);
      color: #111827;
    }

    .page {
      min-height: 100vh;
      padding: 32px 16px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .shell {
      width: 100%;
      max-width: 1120px;
      background: rgba(255,255,255,0.96);
      border-radius: 24px;
      box-shadow:
        0 18px 80px rgba(15,23,42,0.13),
        0 0 0 1px rgba(148,163,184,0.18);
      padding: 24px 28px 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      backdrop-filter: blur(14px);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 10px;
    }

    .title-block h1 {
      font-size: 20px;
      margin: 0;
      letter-spacing: 0.02em;
    }

    .title-block p {
      margin: 2px 0 0;
      font-size: 13px;
      color: #6b7280;
    }

    .badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #ecfeff;
      color: #0369a1;
      border: 1px solid #7dd3fc;
      font-weight: 500;
    }

    .columns {
      display: grid;
      gap: 18px;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
    }

    @media (max-width: 880px) {
      .shell {
        padding: 18px 16px 18px;
      }
      .columns {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 16px 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #eff6ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: #1d4ed8;
    }

    .card-sub {
      font-size: 12px;
      color: #6b7280;
    }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 12px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .field label {
      font-weight: 500;
      color: #374151;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .field small {
      font-size: 11px;
      color: #9ca3af;
      font-weight: 400;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 7px 10px;
      font-size: 12px;
      outline: none;
      background: white;
      transition: border-color 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
    }

    textarea {
      border-radius: 12px;
      min-height: 60px;
      resize: vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
      background: #f9fafb;
    }

    input[type="file"] {
      width: 100%;
      font-size: 12px;
    }

    input[type="range"] {
      width: 100%;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #374151;
      margin-top: 4px;
    }

    .checkbox-row input {
      margin: 0;
    }

    .hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .error {
      font-size: 12px;
      color: #b91c1c;
      margin-top: 4px;
    }

    .button-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
      align-items: center;
    }

    button.primary {
      border-radius: 999px;
      padding: 7px 16px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      background: radial-gradient(circle at top left, #60a5fa 0, #2563eb 40%, #1d4ed8 100%);
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(37,99,235,0.28);
    }

    button.primary[disabled] {
      opacity: 0.65;
      cursor: default;
      box-shadow: none;
    }

    .spinner {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.4);
      border-top-color: white;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Quote side */
    .quote-box {
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 10px 12px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .quote-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .quote-label {
      color: #6b7280;
    }

    .quote-value {
      font-weight: 500;
    }

    .quote-total {
      font-size: 14px;
      font-weight: 600;
    }

    .quote-empty {
      font-size: 12px;
      color: #9ca3af;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="shell">
      <div class="header">
        <div class="title-block">
          <h1>Iceberg 3D – Custom Printing Quote</h1>
          <p>Upload your 3D model, pick your settings, and we’ll generate a detailed quote.</p>
        </div>
        <div class="badge">v2 · Internal Beta</div>
      </div>

      <div class="columns">
        <!-- LEFT: FORM -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="icon">①</span>
                Project &amp; Print Settings
              </div>
              <div class="card-sub">Tell us what you’re printing – we’ll use this to calculate time &amp; material.</div>
            </div>
          </div>

          <div class="field field-file">
            <label>
              3D model file
              <small>Supported: STL, 3MF, OBJ (preview for STL/OBJ/3MF)</small>
            </label>
            <input id="file" type="file" accept=".stl,.STL,.3mf,.3MF,.obj,.OBJ" />
            <div class="hint">If you have multiple parts, please zip them and upload as one file – we’ll treat this as one project.</div>
          </div>

          <div class="field-grid" style="margin-top: 8px;">
            <div class="field">
              <label>
                Material
                <small>PLA / PETG priced for standard jobs</small>
              </label>
              <select id="material">
                <option value="PLA" selected>PLA (standard)</option>
                <option value="PETG">PETG (stronger)</option>
                <option value="ASA">ASA (outdoor)</option>
                <option value="TPU">TPU (flexible)</option>
              </select>
            </div>

            <div class="field">
              <label>
                Layer height
                <small>Smaller = finer detail</small>
              </label>
              <select id="layer_height">
                <option value="0.12">0.12 mm – Fine</option>
                <option value="0.16" selected>0.16 mm – Balanced</option>
                <option value="0.20">0.20 mm – Standard</option>
                <option value="0.28">0.28 mm – Draft</option>
              </select>
            </div>

            <div class="field">
              <label>
                Infill
                <small id="infill-label">20%</small>
              </label>
              <input id="infill" type="range" min="10" max="100" step="5" value="20" />
            </div>

            <div class="field">
              <label>
                Quantity
              </label>
              <input id="quantity" type="number" min="1" value="1" />
            </div>
          </div>

          <div class="checkbox-row">
            <input id="rush" type="checkbox" />
            <label for="rush">Rush order (we’ll prioritise this job, surcharge applies)</label>
          </div>

          <div class="field-grid" style="margin-top: 8px;">
            <div class="field">
              <label>Contact email (optional)</label>
              <input id="email" type="text" placeholder="So we can send you a formal quote" />
            </div>
            <div class="field">
              <label>Reference / project name (optional)</label>
              <input id="project_name" type="text" placeholder="e.g. Architectural model – client X" />
            </div>
          </div>

          <div class="field" style="margin-top: 6px;">
            <label>Notes for Iceberg team (optional)</label>
            <textarea id="notes" placeholder="Tell us about colour preferences, use case, deadlines, or anything special."></textarea>
          </div>

          <div id="form-error" class="error"></div>

          <div class="button-row">
            <button id="btn-quote" class="primary">
              <span id="btn-spinner" class="spinner" style="display:none;"></span>
              <span id="btn-label">Get quote</span>
            </button>
          </div>
        </div>

        <!-- RIGHT: QUOTE -->
        <div class="quote-wrapper">
          <div class="card" style="min-height:120px;">
            <div class="card-header">
              <div>
                <div class="card-title">
                  <span class="icon">②</span>
                  Quote summary
                </div>
                <div class="card-sub">Rotate, pan and zoom – works for STL, OBJ and 3MF uploads.</div>
              </div>
            </div>

            <div class="preview-area">
              <div id="preview-canvas"></div>
              <div id="preview-empty" class="preview-empty">
                <div>No model loaded yet</div>
              <div class="hint">Upload an STL/OBJ/3MF file to see an interactive preview.</div>
              </div>
              <div id="preview-loading" class="preview-loading" style="display:none;">
                <div class="spinner" style="border-color:rgba(37,99,235,0.25);border-top-color:#2563eb;"></div>
                <div>Processing model…</div>
              </div>
            </div>

            <div class="quote-box">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">
              <div style="font-weight:600;font-size:13px;">Quote summary</div>
              <div style="font-size:11px;color:#9ca3af;">Prices are indicative – confirmed upon order.</div>
            </div>

            <div id="quote-empty" class="quote-empty">
              Fill in the form and click <strong>Get quote</strong> to see pricing breakdown here.
            </div>

            <div id="quote-result" style="display:none;">
              <div class="quote-row">
                <div class="quote-label">Price per part</div>
                <div class="quote-value" id="qr-price-per-part">—</div>
              </div>
              <div class="quote-row">
                <div class="quote-label">Quantity</div>
                <div class="quote-value" id="qr-quantity">—</div>
              </div>
              <div class="quote-row">
                <div class="quote-label">Material</div>
                <div class="quote-value" id="qr-material">—</div>
              </div>
              <div class="quote-row">
                <div class="quote-label">Layer height</div>
                <div class="quote-value" id="qr-layer">—</div>
              </div>
              <div class="quote-row">
                <div class="quote-label">Infill</div>
                <div class="quote-value" id="qr-infill">—</div>
              </div>
              <div class="quote-row">
                <div class="quote-label">Rush order</div>
                <div class="quote-value" id="qr-rush">—</div>
              </div>
              <hr style="border:none;border-top:1px dashed #e5e7eb;margin:4px 0;">
              <div class="quote-row">
                <div class="quote-label quote-total">Estimated total</div>
                <div class="quote-value quote-total" id="qr-total">—</div>
              </div>
            </div>
            </div>
          </div>
        </div> <!-- /quote-wrapper -->
      </div> <!-- /columns -->
    </div> <!-- /shell -->
  </div> <!-- /page -->

    <script>
    // ===== INFILL LABEL =====
    const infillSlider = document.getElementById("infill");
    const infillLabel  = document.getElementById("infill-label");
    infillSlider.addEventListener("input", () => {
      infillLabel.textContent = infillSlider.value + "%";
    });

    // ===== THREE.JS PREVIEW (STL / OBJ / 3MF) =====
    let scene, camera, renderer, controls;
    let currentObject = null;
    let boxHelper = null;
    const previewContainer = document.getElementById("preview-canvas");
    const previewEmpty = document.getElementById("preview-empty");
    const previewLoading = document.getElementById("preview-loading");
    const previewMeta = document.getElementById("preview-meta");
    const previewFilename = document.getElementById("preview-filename");
    const previewSize = document.getElementById("preview-size");

    function initPreview() {
      const width = previewContainer.clientWidth || 320;
      const height = previewContainer.clientHeight || 260;

      scene = new THREE.Scene();
      scene.background = null;

      camera = new THREE.PerspectiveCamera(40, width / height, 0.1, 1000);
      camera.position.set(140, 110, 140);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(width, height);
      renderer.setPixelRatio(window.devicePixelRatio || 1);
      previewContainer.appendChild(renderer.domElement);

      const keyLight = new THREE.DirectionalLight(0xffffff, 0.95);
      keyLight.position.set(80, 120, 60);
      scene.add(keyLight);

      const fillLight = new THREE.DirectionalLight(0xffffff, 0.55);
      fillLight.position.set(-60, 80, -40);
      scene.add(fillLight);

      const rimLight = new THREE.DirectionalLight(0xffffff, 0.45);
      rimLight.position.set(0, 120, -80);
      scene.add(rimLight);

      const ambient = new THREE.AmbientLight(0xffffff, 0.45);
      scene.add(ambient);

      const floorGeom = new THREE.CircleGeometry(120, 60);
      const floorMat = new THREE.MeshPhongMaterial({
        color: 0xe5e7eb,
        shininess: 10,
        specular: 0xf9fafb
      });
      const floor = new THREE.Mesh(floorGeom, floorMat);
      floor.rotation.x = -Math.PI / 2;
      floor.position.y = -0.01;
      scene.add(floor);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.06;
      controls.rotateSpeed = 0.85;
      controls.zoomSpeed = 0.8;
      controls.panSpeed = 0.6;

      window.addEventListener("resize", onWindowResize);
      animate();
    }

    function onWindowResize() {
      if (!renderer) return;
      const width = previewContainer.clientWidth || 320;
      const height = previewContainer.clientHeight || 260;
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
      renderer.setSize(width, height);
    }

    function animate() {
      requestAnimationFrame(animate);
      if (controls) controls.update();
      if (renderer && scene && camera) {
        renderer.render(scene, camera);
      }
    }

    function disposeObject(object) {
      if (!object) return;
      object.traverse((child) => {
        if (child.isMesh) {
          child.geometry?.dispose?.();
          if (Array.isArray(child.material)) {
            child.material.forEach((m) => m?.dispose?.());
          } else {
            child.material?.dispose?.();
          }
        }
      });
    }

    function clearCurrentObject() {
      if (currentObject) {
        disposeObject(currentObject);
        scene.remove(currentObject);
        currentObject = null;
      }
      if (boxHelper) {
        scene.remove(boxHelper);
        boxHelper = null;
      }
    }

    function centerAndFocus(object, fileName) {
      clearCurrentObject();
      currentObject = object;
      scene.add(currentObject);

      const box = new THREE.Box3().setFromObject(currentObject);
      const size = new THREE.Vector3();
      const center = new THREE.Vector3();
      box.getSize(size);
      box.getCenter(center);

      currentObject.position.sub(center);
      currentObject.position.y -= box.min.y;

      const maxDim = Math.max(size.x, size.y, size.z) || 1;
      const dist = maxDim * 2.4;
      camera.position.set(dist, dist * 0.8, dist);
      camera.lookAt(new THREE.Vector3(0, size.y / 2, 0));
      controls.target.set(0, size.y / 2, 0);
      controls.update();

      boxHelper = new THREE.Box3Helper(box, 0x9ca3af);
      scene.add(boxHelper);

      previewFilename.textContent = fileName;
      previewSize.textContent = `Approx. size: ${size.x.toFixed(1)} × ${size.y.toFixed(1)} × ${size.z.toFixed(1)} mm`;
      previewMeta.style.display = "flex";
    }

    function prepareObjectMaterials(object) {
      object.traverse((child) => {
        if (child.isMesh) {
          if (!child.material) {
            child.material = new THREE.MeshPhongMaterial({ color: 0x1d4ed8, specular: 0x93c5fd, shininess: 85 });
          } else if (!child.material.isMeshPhongMaterial) {
            child.material = new THREE.MeshPhongMaterial({
              color: child.material.color || new THREE.Color(0x1d4ed8),
              shininess: 70,
            });
          }
        }
      });
    }

    function showLoading() {
      previewEmpty.style.display = "none";
      previewLoading.style.display = "flex";
      previewMeta.style.display = "none";
    }

    function handleLoadError(message) {
      clearCurrentObject();
      previewLoading.style.display = "none";
      previewEmpty.style.display = "flex";
      alert(message || "Failed to read file for preview, but you can still request a quote.");
    }

    function loadModelFromFile(file) {
      const ext = file.name.split(".").pop().toLowerCase();
      showLoading();

      if (ext === "stl") {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const loader = new THREE.STLLoader();
            const geometry = loader.parse(e.target.result);
            const mesh = new THREE.Mesh(
              geometry,
              new THREE.MeshPhongMaterial({ color: 0x1d4ed8, specular: 0x93c5fd, shininess: 85 })
            );
            centerAndFocus(mesh, file.name);
            previewLoading.style.display = "none";
          } catch (err) {
            handleLoadError("Failed to parse STL file for preview.");
          }
        };
        reader.onerror = () => handleLoadError();
        reader.readAsArrayBuffer(file);
        return;
      }

      if (ext === "obj") {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const loader = new THREE.OBJLoader();
            const object = loader.parse(e.target.result);
            prepareObjectMaterials(object);
            centerAndFocus(object, file.name);
            previewLoading.style.display = "none";
          } catch (err) {
            handleLoadError("Failed to parse OBJ file for preview.");
          }
        };
        reader.onerror = () => handleLoadError();
        reader.readAsText(file);
        return;
      }

      if (ext === "3mf") {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const loader = new THREE.ThreeMFLoader();
            const object = loader.parse(e.target.result);
            prepareObjectMaterials(object);
            centerAndFocus(object, file.name);
            previewLoading.style.display = "none";
          } catch (err) {
            handleLoadError("Failed to parse 3MF file for preview.");
          }
        };
        reader.onerror = () => handleLoadError();
        reader.readAsArrayBuffer(file);
        return;
      }

      handleLoadError("Unsupported file type for preview. Please upload STL, OBJ or 3MF.");
    }

    // When file chosen
    document.getElementById("file").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      loadModelFromFile(file);
    });

    // ===== QUOTE REQUEST HANDLER =====
    const btnQuote = document.getElementById("btn-quote");
    const btnLabel = document.getElementById("btn-label");
    const btnSpinner = document.getElementById("btn-spinner");
    const formError = document.getElementById("form-error");

    const quoteEmpty = document.getElementById("quote-empty");
    const quoteResult = document.getElementById("quote-result");

    btnQuote.addEventListener("click", () => {
      formError.textContent = "";

      const fileInput = document.getElementById("file");
      const file = fileInput.files[0];
      if (!file) {
        formError.textContent = "Please upload at least one 3D model file first.";
        return;
      }

      const quantity = parseInt(document.getElementById("quantity").value || "1", 10);
      if (!quantity || quantity < 1) {
        formError.textContent = "Quantity must be at least 1.";
        return;
      }

      btnQuote.disabled = true;
      btnSpinner.style.display = "inline-block";
      btnLabel.textContent = "Calculating…";

      const material = document.getElementById("material").value;
      const layerHeight = document.getElementById("layer_height").value;
      const infill = parseInt(infillSlider.value, 10);
      const rush = document.getElementById("rush").checked;

      // Pricing model
      const volumeCm3 = estimateVolumeCm3(file.size);
      const materialFactor = MATERIAL_MULTIPLIER[material] || 1;
      const layerFactor = LAYER_MULTIPLIER[layerHeight] || 1;
      const infillFactor = 0.4 + (infill / 100) * 0.6;

      const baseRatePerCm3 = 0.25; // £ per cm³
      const setupFee = 5; // flat per-part setup/handling

      let pricePerPart = setupFee + volumeCm3 * baseRatePerCm3 * materialFactor * layerFactor * infillFactor;
      if (rush) {
        pricePerPart *= 1.25;
      }

      const total = pricePerPart * quantity;

      document.getElementById("qr-price-per-part").textContent = formatMoney(pricePerPart);
      document.getElementById("qr-quantity").textContent = quantity;
      document.getElementById("qr-material").textContent = material;
      document.getElementById("qr-layer").textContent = `${layerHeight} mm`;
      document.getElementById("qr-infill").textContent = `${infill}%`;
      document.getElementById("qr-rush").textContent = rush ? "Yes" : "No";
      document.getElementById("qr-total").textContent = formatMoney(total);

      quoteEmpty.style.display = "none";
      quoteResult.style.display = "block";

      btnQuote.disabled = false;
      btnSpinner.style.display = "none";
      btnLabel.textContent = "Get quote";
    });
  </script>
</body>
</html>
